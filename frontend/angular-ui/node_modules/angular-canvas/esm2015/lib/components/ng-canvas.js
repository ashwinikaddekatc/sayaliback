function getArrayDrawingComponents(set) {
    return Array.from(set.values()).filter((c) => c && !!c.draw);
}
export class NgCanvas {
    constructor(ngZone, config) {
        this.ngZone = ngZone;
        this.config = config;
        this.componentSet = new Set();
        this.componentsDrawings = [];
        this.element = document.createElement('canvas');
        this.element.style.position = 'absolute';
        this.context = this.element.getContext('2d');
        this._height = this.element.height;
        this._width = this.element.width;
        this.ngZone.runOutsideAngular(() => {
            window.requestAnimationFrame((time) => this.draw(time));
        });
    }
    get width() {
        return this._width;
    }
    get height() {
        return this._height;
    }
    set parent(element) {
        this._parentElement = element;
        this.subResizeEvent();
    }
    subResizeEvent() {
        this._parentElement &&
            this.resizeObserver &&
            this.resizeObserver.unobserve(this._parentElement);
        // @ts-ignore
        this.resizeObserver = new ResizeObserver(([entry]) => {
            const dpr = window.devicePixelRatio || 1;
            let width = entry.contentRect.width;
            let height = entry.contentRect.height;
            if (width && height) {
                width = parseInt(width, 10);
                height = parseInt(height, 10);
            }
            let resizeDetected = false;
            if (this._width !== width) {
                this._width = width;
                this.element.width = width * dpr;
                this.element.style.width = width + 'px';
                resizeDetected = true;
            }
            if (this._height !== height) {
                this._height = height;
                this.element.height = height * dpr;
                this.element.style.height = height + 'px';
                resizeDetected = true;
            }
            if (resizeDetected) {
                if (dpr !== 1) {
                    this.context.scale(dpr, dpr);
                }
                this.drawWithoutRequestAnimation();
            }
        });
        this.resizeObserver.observe(this._parentElement);
    }
    resetCanvasSize() {
        const dpr = window.devicePixelRatio || 1;
        this.element.width = this._width * dpr;
        this.element.style.width = this._width + 'px';
        this.element.height = this._height * dpr;
        this.element.style.height = this._height + 'px';
    }
    // tslint:disable-next-line:typedef
    get parent() {
        return this._parent;
    }
    // tslint:disable-next-line:typedef
    destroy() {
        this.resizeObserver &&
            this._parentElement &&
            this.resizeObserver.unobserve(this._parentElement);
        this.componentSet.clear();
        this.componentsDrawings = null;
        this.element && this.element.remove();
    }
    addClass(name) {
        this.element.setAttribute('class', name);
    }
    appendChild(newChild) {
        newChild.onInit && newChild.onInit(this.context);
        this.componentSet.add(newChild);
        this.componentsDrawings = getArrayDrawingComponents(this.componentSet);
        this.drawAll();
    }
    removeChild(oldChild) {
        oldChild.onDestroy && oldChild.onDestroy(this.context);
        this.componentSet.delete(oldChild);
        this.componentsDrawings = getArrayDrawingComponents(this.componentSet);
        this.drawAll();
    }
    insertBefore(newChild, refChild) {
        this.componentSet.add(newChild);
        this.componentsDrawings = getArrayDrawingComponents(this.componentSet);
        this.drawAll();
    }
    recalculateElementsDraw() {
        this.componentsDrawings = getArrayDrawingComponents(this.componentSet);
    }
    removeAttribute(name, namespace) {
        this.element.removeAttribute(name);
    }
    removeClass(name) {
        this.element.classList.remove(name);
    }
    removeStyle(style, flags) {
        // Not supported
    }
    setAttribute(name, value) {
        this.element.setAttribute(name, value);
    }
    setNgAttribute(name, value, namespace) {
        this.element.setAttribute(name, value);
    }
    setNgProperty(name, value) {
        // Not supported
    }
    setStyle(style, value, flags) {
        // Not supported
    }
    setValue(value) {
        // Not supported
    }
    drawAll(clear) {
        this.ngZone.runOutsideAngular(() => {
            this.requestId && window.cancelAnimationFrame(this.requestId);
            this.requestId = window.requestAnimationFrame((time) => {
                this.draw(time, clear);
                this.requestId = null;
            });
        });
    }
    drawWithoutRequestAnimation() {
        this.ngZone.runOutsideAngular(() => {
            this.draw(0, false);
            this.requestId = null;
        });
    }
    // @ts-ignore
    draw(time, clear = true) {
        const context = this.context;
        if (clear) {
            context.clearRect(0, 0, this.width, this.height);
        }
        let needDraw = false;
        const elementsCount = this.componentsDrawings && this.componentsDrawings.length;
        if (elementsCount) {
            for (let i = 0; i < elementsCount; i++) {
                this.componentsDrawings[i].draw(context, time);
                needDraw = needDraw || this.componentsDrawings[i].needDraw;
            }
            if (needDraw) {
                this.requestId && window.cancelAnimationFrame(this.requestId);
                this.requestId = window.requestAnimationFrame((time) => this.draw(time));
            }
        }
    }
}
NgCanvas.nodeName = 'canvas';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctY2FudmFzLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9pcnVzdG0vZGV2L2dpdGh1Yi9hbmd1bGFyLWNhbnZhcy9wcm9qZWN0cy9hbmd1bGFyLWNhbnZhcy1saWIvc3JjLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvbmctY2FudmFzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUlBLFNBQVMseUJBQXlCLENBQ2hDLEdBQXlCO0lBRXpCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQ3BDLENBQUMsQ0FBa0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNqQixDQUFDO0FBQ3pCLENBQUM7QUFFRCxNQUFNLE9BQU8sUUFBUTtJQTJGbkIsWUFDbUIsTUFBYyxFQUNkLE1BQStCO1FBRC9CLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxXQUFNLEdBQU4sTUFBTSxDQUF5QjtRQVJqQyxpQkFBWSxHQUFHLElBQUksR0FBRyxFQUFtQixDQUFDO1FBQ25ELHVCQUFrQixHQUFzQixFQUFFLENBQUM7UUFTakQsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFVLENBQUM7UUFDekMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU3QyxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ25DLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFFakMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7WUFDakMsTUFBTSxD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LFFBQVEsR0FBRyxLQUFLLENBQUM7UUFFckIsTUFBTSxhQUFhLEdBQ2pCLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDO1FBRTVELElBQUksYUFBYSxFQUFFO1lBQ2pCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUMvQyxRQUFRLEdBQUcsUUFBUSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7YUFDNUQ7WUFFRCxJQUFJLFFBQVEsRUFBRTtnQkFDWixJQUFJLENBQUMsU0FBUyxJQUFJLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzlELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FDaEIsQ0FBQzthQUNIO1NBQ0Y7SUFDSCxDQUFDOztBQTFOYSxpQkFBUSxHQUFHLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5nQ2FudmFzRWxlbWVudCB9IGZyb20gJy4vbmctY2FudmFzLWVsZW1lbnQnO1xuaW1wb3J0IHsgTmdab25lLCBSZW5kZXJlclN0eWxlRmxhZ3MyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDYW52YXNSZW5kZXJDb25maWdNb2RlbCB9IGZyb20gJy4uL3Rva2Vucy9jYW52YXMtcmVzaXplLW9ic2VyZXItZW5hYmxlLXRva2VuJztcblxuZnVuY3Rpb24gZ2V0QXJyYXlEcmF3aW5nQ29tcG9uZW50cyhcbiAgc2V0OiBTZXQ8TmdDYW52YXNFbGVtZW50PlxuKTogTmdDYW52YXNFbGVtZW50W10ge1xuICByZXR1cm4gQXJyYXkuZnJvbShzZXQudmFsdWVzKCkpLmZpbHRlcihcbiAgICAoYzogTmdDYW52YXNFbGVtZW50KSA9PiBjICYmICEhYy5kcmF3XG4gICkgYXMgTmdDYW52YXNFbGVtZW50W107XG59XG5cbmV4cG9ydCBjbGFzcyBOZ0NhbnZhcyB7XG4gIHB1YmxpYyBzdGF0aWMgbm9kZU5hbWUgPSAnY2FudmFzJztcbiAgcHVibGljIHJlYWRvbmx5IGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcbiAgcHVibGljIHJlYWRvbmx5IGVsZW1lbnQ6IEhUTUxDYW52YXNFbGVtZW50O1xuXG4gIHB1YmxpYyBnZXQgd2lkdGgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fd2lkdGg7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGhlaWdodCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9oZWlnaHQ7XG4gIH1cblxuICBwcml2YXRlIHJlcXVlc3RJZDogbnVtYmVyO1xuICBwcml2YXRlIF93aWR0aDogbnVtYmVyO1xuICBwcml2YXRlIF9oZWlnaHQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBfcGFyZW50RWxlbWVudDogSFRNTENhbnZhc0VsZW1lbnQ7XG5cbiAgcHVibGljIHNldCBwYXJlbnQoZWxlbWVudCkge1xuICAgIHRoaXMuX3BhcmVudEVsZW1lbnQgPSBlbGVtZW50O1xuICAgIHRoaXMuc3ViUmVzaXplRXZlbnQoKTtcbiAgfVxuXG4gIHByaXZhdGUgc3ViUmVzaXplRXZlbnQoKSB7XG4gICAgdGhpcy5fcGFyZW50RWxlbWVudCAmJlxuICAgICAgdGhpcy5yZXNpemVPYnNlcnZlciAmJlxuICAgICAgdGhpcy5yZXNpemVPYnNlcnZlci51bm9ic2VydmUodGhpcy5fcGFyZW50RWxlbWVudCk7XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgdGhpcy5yZXNpemVPYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoW2VudHJ5XSkgPT4ge1xuICAgICAgY29uc3QgZHByOiBudW1iZXIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxO1xuXG4gICAgICBsZXQgd2lkdGggPSBlbnRyeS5jb250ZW50UmVjdC53aWR0aDtcbiAgICAgIGxldCBoZWlnaHQgPSBlbnRyeS5jb250ZW50UmVjdC5oZWlnaHQ7XG5cbiAgICAgIGlmICh3aWR0aCAmJiBoZWlnaHQpIHtcbiAgICAgICAgd2lkdGggPSBwYXJzZUludCh3aWR0aCwgMTApO1xuICAgICAgICBoZWlnaHQgPSBwYXJzZUludChoZWlnaHQsIDEwKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHJlc2l6ZURldGVjdGVkID0gZmFsc2U7XG5cbiAgICAgIGlmICh0aGlzLl93aWR0aCAhPT0gd2lkdGgpIHtcbiAgICAgICAgdGhpcy5fd2lkdGggPSB3aWR0aDtcbiAgICAgICAgdGhpcy5lbGVtZW50LndpZHRoID0gd2lkdGggKiBkcHI7XG4gICAgICAgIHRoaXMuZWxlbWVudC5zdHlsZS53aWR0aCA9IHdpZHRoICsgJ3B4JztcbiAgICAgICAgcmVzaXplRGV0ZWN0ZWQgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5faGVpZ2h0ICE9PSBoZWlnaHQpIHtcbiAgICAgICAgdGhpcy5faGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICB0aGlzLmVsZW1lbnQuaGVpZ2h0ID0gaGVpZ2h0ICogZHByO1xuICAgICAgICB0aGlzLmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JztcbiAgICAgICAgcmVzaXplRGV0ZWN0ZWQgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAocmVzaXplRGV0ZWN0ZWQpIHtcbiAgICAgICAgaWYgKGRwciAhPT0gMSkge1xuICAgICAgICAgIHRoaXMuY29udGV4dC5zY2FsZShkcHIsIGRwcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRyYXdXaXRob3V0UmVxdWVzdEFuaW1hdGlvbigpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5yZXNpemVPYnNlcnZlci5vYnNlcnZlKHRoaXMuX3BhcmVudEVsZW1lbnQpO1xuICB9XG5cbiAgcHVibGljIHJlc2V0Q2FudmFzU2l6ZSgpIHtcbiAgICBjb25zdCBkcHI6IG51bWJlciA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDE7XG4gICAgdGhpcy5lbGVtZW50LndpZHRoID0gdGhpcy5fd2lkdGggKiBkcHI7XG4gICAgdGhpcy5lbGVtZW50LnN0eWxlLndpZHRoID0gdGhpcy5fd2lkdGggKyAncHgnO1xuXG4gICAgdGhpcy5lbGVtZW50LmhlaWdodCA9IHRoaXMuX2hlaWdodCAqIGRwcjtcbiAgICB0aGlzLmVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gdGhpcy5faGVpZ2h0ICsgJ3B4JztcbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0eXBlZGVmXG4gIHB1YmxpYyBnZXQgcGFyZW50KCkge1xuICAgIHJldHVybiB0aGlzLl9wYXJlbnQ7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZVxuICBwcml2YXRlIF9wYXJlbnQ6IGFueTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGNvbXBvbmVudFNldCA9IG5ldyBTZXQ8TmdDYW52YXNFbGVtZW50PigpO1xuICBwcml2YXRlIGNvbXBvbmVudHNEcmF3aW5nczogTmdDYW52YXNFbGVtZW50W10gPSBbXTtcblxuICAvLyBAdHMtaWdub3JlXG4gIHByaXZhdGUgcmVzaXplT2JzZXJ2ZXI6IFJlc2l6ZU9ic2VydmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbmdab25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IENhbnZhc1JlbmRlckNvbmZpZ01vZGVsXG4gICkge1xuICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgIHRoaXMuZWxlbWVudC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7XG4gICAgdGhpcy5jb250ZXh0ID0gdGhpcy5lbGVtZW50LmdldENvbnRleHQoJzJkJyk7XG5cbiAgICB0aGlzLl9oZWlnaHQgPSB0aGlzLmVsZW1lbnQuaGVpZ2h0O1xuICAgIHRoaXMuX3dpZHRoID0gdGhpcy5lbGVtZW50LndpZHRoO1xuXG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgodGltZSkgPT4gdGhpcy5kcmF3KHRpbWUpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0eXBlZGVmXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZXNpemVPYnNlcnZlciAmJlxuICAgICAgdGhpcy5fcGFyZW50RWxlbWVudCAmJlxuICAgICAgdGhpcy5yZXNpemVPYnNlcnZlci51bm9ic2VydmUodGhpcy5fcGFyZW50RWxlbWVudCk7XG4gICAgdGhpcy5jb21wb25lbnRTZXQuY2xlYXIoKTtcbiAgICB0aGlzLmNvbXBvbmVudHNEcmF3aW5ncyA9IG51bGw7XG4gICAgdGhpcy5lbGVtZW50ICYmIHRoaXMuZWxlbWVudC5yZW1vdmUoKTtcbiAgfVxuXG4gIGFkZENsYXNzKG5hbWUpOiB2b2lkIHtcbiAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIG5hbWUpO1xuICB9XG5cbiAgYXBwZW5kQ2hpbGQobmV3Q2hpbGQ6IE5nQ2FudmFzRWxlbWVudCk6IHZvaWQge1xuICAgIG5ld0NoaWxkLm9uSW5pdCAmJiBuZXdDaGlsZC5vbkluaXQodGhpcy5jb250ZXh0KTtcbiAgICB0aGlzLmNvbXBvbmVudFNldC5hZGQobmV3Q2hpbGQpO1xuICAgIHRoaXMuY29tcG9uZW50c0RyYXdpbmdzID0gZ2V0QXJyYXlEcmF3aW5nQ29tcG9uZW50cyh0aGlzLmNvbXBvbmVudFNldCk7XG4gICAgdGhpcy5kcmF3QWxsKCk7XG4gIH1cblxuICByZW1vdmVDaGlsZChvbGRDaGlsZDogTmdDYW52YXNFbGVtZW50KTogdm9pZCB7XG4gICAgb2xkQ2hpbGQub25EZXN0cm95ICYmIG9sZENoaWxkLm9uRGVzdHJveSh0aGlzLmNvbnRleHQpO1xuICAgIHRoaXMuY29tcG9uZW50U2V0LmRlbGV0ZShvbGRDaGlsZCk7XG4gICAgdGhpcy5jb21wb25lbnRzRHJhd2luZ3MgPSBnZXRBcnJheURyYXdpbmdDb21wb25lbnRzKHRoaXMuY29tcG9uZW50U2V0KTtcbiAgICB0aGlzLmRyYXdBbGwoKTtcbiAgfVxuXG4gIGluc2VydEJlZm9yZShuZXdDaGlsZDogYW55LCByZWZDaGlsZDogYW55KTogdm9pZCB7XG4gICAgdGhpcy5jb21wb25lbnRTZXQuYWRkKG5ld0NoaWxkKTtcbiAgICB0aGlzLmNvbXBvbmVudHNEcmF3aW5ncyA9IGdldEFycmF5RHJhd2luZ0NvbXBvbmVudHModGhpcy5jb21wb25lbnRTZXQpO1xuICAgIHRoaXMuZHJhd0FsbCgpO1xuICB9XG5cbiAgcmVjYWxjdWxhdGVFbGVtZW50c0RyYXcoKTogdm9pZCB7XG4gICAgdGhpcy5jb21wb25lbnRzRHJhd2luZ3MgPSBnZXRBcnJheURyYXdpbmdDb21wb25lbnRzKHRoaXMuY29tcG9uZW50U2V0KTtcbiAgfVxuXG4gIHJlbW92ZUF0dHJpYnV0ZShuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyB8IG51bGwpOiB2b2lkIHtcbiAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKG5hbWUpO1xuICB9XG5cbiAgcmVtb3ZlQ2xhc3MobmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUobmFtZSk7XG4gIH1cblxuICByZW1vdmVTdHlsZShzdHlsZTogc3RyaW5nLCBmbGFncz86IFJlbmRlcmVyU3R5bGVGbGFnczIpOiB2b2lkIHtcbiAgICAvLyBOb3Qgc3VwcG9ydGVkXG4gIH1cblxuICBzZXRBdHRyaWJ1dGUobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gIH1cblxuICBzZXROZ0F0dHJpYnV0ZShuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyB8IG51bGwpOiB2b2lkIHtcbiAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgfVxuXG4gIHNldE5nUHJvcGVydHkobmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgLy8gTm90IHN1cHBvcnRlZFxuICB9XG5cbiAgc2V0U3R5bGUoc3R5bGU6IHN0cmluZywgdmFsdWU6IGFueSwgZmxhZ3M/OiBSZW5kZXJlclN0eWxlRmxhZ3MyKTogdm9pZCB7XG4gICAgLy8gTm90IHN1cHBvcnRlZFxuICB9XG5cbiAgc2V0VmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIC8vIE5vdCBzdXBwb3J0ZWRcbiAgfVxuXG4gIGRyYXdBbGwoY2xlYXI/OiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy5yZXF1ZXN0SWQgJiYgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMucmVxdWVzdElkKTtcbiAgICAgIHRoaXMucmVxdWVzdElkID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgodGltZSkgPT4ge1xuICAgICAgICB0aGlzLmRyYXcodGltZSwgY2xlYXIpO1xuICAgICAgICB0aGlzLnJlcXVlc3RJZCA9IG51bGw7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZHJhd1dpdGhvdXRSZXF1ZXN0QW5pbWF0aW9uKCk6IHZvaWQge1xuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMuZHJhdygwLCBmYWxzZSk7XG4gICAgICB0aGlzLnJlcXVlc3RJZCA9IG51bGw7XG4gICAgfSk7XG4gIH1cblxuICAvLyBAdHMtaWdub3JlXG4gIGRyYXcodGltZTogbnVtYmVyLCBjbGVhciA9IHRydWUpOiB2b2lkIHtcbiAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5jb250ZXh0O1xuICAgIGlmIChjbGVhcikge1xuICAgICAgY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpO1xuICAgIH1cblxuICAgIGxldCBuZWVkRHJhdyA9IGZhbHNlO1xuXG4gICAgY29uc3QgZWxlbWVudHNDb3VudCA9XG4gICAgICB0aGlzLmNvbXBvbmVudHNEcmF3aW5ncyAmJiB0aGlzLmNvbXBvbmVudHNEcmF3aW5ncy5sZW5ndGg7XG5cbiAgICBpZiAoZWxlbWVudHNDb3VudCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtZW50c0NvdW50OyBpKyspIHtcbiAgICAgICAgdGhpcy5jb21wb25lbnRzRHJhd2luZ3NbaV0uZHJhdyhjb250ZXh0LCB0aW1lKTtcbiAgICAgICAgbmVlZERyYXcgPSBuZWVkRHJhdyB8fCB0aGlzLmNvbXBvbmVudHNEcmF3aW5nc1tpXS5uZWVkRHJhdztcbiAgICAgIH1cblxuICAgICAgaWYgKG5lZWREcmF3KSB7XG4gICAgICAgIHRoaXMucmVxdWVzdElkICYmIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLnJlcXVlc3RJZCk7XG4gICAgICAgIHRoaXMucmVxdWVzdElkID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgodGltZSkgPT5cbiAgICAgICAgICB0aGlzLmRyYXcodGltZSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==