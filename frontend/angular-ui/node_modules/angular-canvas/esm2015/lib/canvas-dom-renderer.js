import { Inject, Injectable, NgZone, RendererStyleFlags2, ViewEncapsulation, } from '@angular/core';
import { NgCanvas } from './components/ng-canvas';
import { EventManager, ɵDomSharedStylesHost as DomSharedStylesHost, } from '@angular/platform-browser';
import { DefaultDomRenderer2, EmulatedEncapsulationDomRenderer2, ShadowDomRenderer, } from './default-dom-renderer';
import { flattenStyles, NAMESPACE_URIS, shimContentAttribute, shimHostAttribute, } from './renderer-utils';
import { getMetadataArgsStorage } from './metadata/metadata-storage';
import { CanvasRenderConfig, } from './tokens/canvas-resize-obserer-enable-token';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/platform-browser';
export class CanvasDomRendererFactory {
    constructor(eventManager, sharedStylesHost, appId, ngZone, canvasConfig) {
        this.eventManager = eventManager;
        this.sharedStylesHost = sharedStylesHost;
        this.appId = appId;
        this.ngZone = ngZone;
        this.canvasConfig = canvasConfig;
        this.rendererByCompId = new Map();
        this.defaultRenderer = new DefaultDomRenderer2(eventManager);
    }
    end() { }
    createRenderer(element, type) {
        if (!element || !type) {
            return this.defaultRenderer;
        }
        // @ts-ignore
        if (type['type'] && type['type'].isCanvasComponent) {
            let renderer = this.rendererByCompId.get(type.id);
            if (!renderer) {
                renderer = new CanvasRenderer(this.eventManager, this.sharedStylesHost, type, this.appId, this.ngZone, this.canvasConfig);
                this.rendererByCompId.set(type.id, renderer);
            }
            renderer.applyToHost(element);
            return renderer;
        }
        switch (type.encapsulation) {
            case ViewEncapsulation.Emulated: {
                let renderer = this.rendererByCompId.get(type.id);
                if (!renderer) {
                    renderer = new EmulatedEncapsulationDomRenderer2(this.eventManager, this.sharedStylesHost, type, this.appId);
                    this.rendererByCompId.set(type.id, renderer);
                }
                renderer.applyToHost(element);
                return renderer;
            }
            case ViewEncapsulation.ShadowDom:
                return new ShadowDomRenderer(this.eventManager, this.sharedStylesHost, element, type);
            default: {
                if (!this.rendererByCompId.has(type.id)) {
                    const styles = flattenStyles(type.id, type.styles, []);
                    this.sharedStylesHost.addStyles(styles);
                    this.rendererByCompId.set(type.id, this.defaultRenderer);
                }
                return this.defaultRenderer;
            }
        }
    }
}
CanvasDomRendererFactory.ɵfac = function CanvasDomRendererFactory_Factory(t) { return new (t || CanvasDomRendererFactory)(ɵngcc0.ɵɵinject(ɵngcc1.EventManager), ɵngcc0.ɵɵinject(ɵngcc1.ɵDomSharedStylesHost), ɵngcc0.ɵɵinject(String), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(CanvasRenderConfig)); };
CanvasDomRendererFactory.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: CanvasDomRendererFactory, factory: CanvasDomRendererFactory.ɵfac });
CanvasDomRendererFactory.ctorParameters = () => [
    { type: EventManager },
    { type: DomSharedStylesHost },
    { type: String },
    { type: NgZone },
    { type: undefined, decorators: [{ type: Inject, args: [CanvasRenderConfig,] }] }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(CanvasDomRendererFactory, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.EventManager }, { type: ɵngcc1.ɵDomSharedStylesHost }, { type: String }, { type: ɵngcc0.NgZone }, { type: undefined, decorators: [{
                type: Inject,
                args: [CanvasRenderConfig]
            }] }]; }, null); })();
export class CanvasRenderer {
    constructor(eventManager, sharedStylesHost, component, appId, ngZone, config) {
        this.component = component;
        this.ngZone = ngZone;
        this.config = config;
        this.canvasElements = getMetadataArgsStorage().elements;
        const styles = flattenStyles(appId + '-' + component.id, component.styles, []);
        sharedStylesHost.addStyles(styles);
        this.contentAttr = shimContentAttribute(appId + '-' + component.id);
        this.hostAttr = shimHostAttribute(appId + '-' + component.id);
    }
    // tslint:disable-next-line:typedef
    applyToHost(element) {
        this.setAttribute(element, this.hostAttr, '');
    }
    createElement(name, namespace) {
        const Component = this.canvasElements.get(name);
        if (Component) {
            return new Component();
        }
        else if (name === 'canvas') {
            const canvas = new NgCanvas(this.ngZone, this.config);
            canvas.element.setAttribute(this.contentAttr, '');
            return canvas;
        }
        else {
            let element;
            if (namespace) {
                // In cases where Ivy (not ViewEngine) is giving us the actual namespace, the look up by key
                // will result in undefined, so we just return the namespace here.
                element = document.createElementNS(NAMESPACE_URIS[namespace] || namespace, name);
            }
            else {
                element = document.createElement(name);
            }
            this.setAttribute(element, this.contentAttr, '');
            return element;
        }
    }
    createText(value) {
        return document.createTextNode(value);
    }
    selectRootElement(selectorOrNode, preserveContent) {
        const el = typeof selectorOrNode === 'string'
            ? document.querySelector(selectorOrNode)
            : selectorOrNode;
        if (!el) {
            throw new Error(`The selector "${selectorOrNode}" did not match any elements`);
        }
        if (!preserveContent) {
            el.textContent = '';
        }
        return el;
    }
    addClass(el, name) {
        if (el.classList) {
            el.classList.add(name);
        }
        else {
            el.addClass(name);
        }
    }
    removeClass(el, name) {
        if (el.classList) {
            el.classList.add(name);
        }
        else {
            el.removeClass(name);
        }
    }
    appendChild(parent, newChild) {
        // parent.appendChild(newChild);
        if (!newChild) {
            return;
        }
        newChild.parent = parent;
        if (newChild instanceof NgCanvas) {
            parent.appendChild(newChild.element);
        }
        else {
            parent.appendChild(newChild);
        }
    }
    removeChild(parent, oldChild) {
        // tslint:disable-next-line:no-unused-expression
        oldChild.destroy && oldChild.destroy();
        if (parent) {
            parent.removeChild(oldChild);
        }
        if (oldChild && oldChild.parent instanceof NgCanvas) {
            oldChild.parent.removeChild(oldChild);
        }
    }
    createComment(value) {
        return document.createComment(value);
    }
    destroy() { }
    insertBefore(parent, newChild, refChild) {
        if (parent && parent.insertBefore) {
            newChild.parent = parent;
            if (newChild instanceof NgCanvas) {
                parent.insertBefore(newChild.element, refChild);
            }
            else {
                parent.insertBefore(newChild, refChild);
            }
        }
    }
    listen(target, eventName, callback) {
        const callbackFunc = (e) => callback.call(target, e);
        if (target instanceof NgCanvas) {
            target = target.element;
        }
        target.addEventListener(eventName, callbackFunc);
        return () => target.removeEventListener(eventName, callbackFunc);
    }
    // tslint:disable-next-line:typedef
    nextSibling(node) {
        return {
            previous: node,
            next: node.nextSibling,
        };
    }
    parentNode(node) {
        return node.parent ? node.parent : node;
    }
    removeAttribute(el, name, namespace) {
        if (namespace) {
            // TODO(FW-811): Ivy may cause issues here because it's passing around
            // full URIs for namespaces, therefore this lookup will fail.
            const namespaceUri = NAMESPACE_URIS[namespace];
            if (namespaceUri) {
                el.removeAttributeNS(namespaceUri, name);
            }
            else {
                // TODO(FW-811): Since ivy is passing around full URIs for namespaces
                // this could result in properties like `http://www.w3.org/2000/svg:cx="123"`,
                // which is wrong.
                el.removeAttribute(`${namespace}:${name}`);
            }
        }
        else {
            el.removeAttribute(name);
        }
    }
    removeStyle(el, style, flags) {
        el.removeStyle(style, flags);
    }
    setAttribute(el, name, value, namespace) {
        if (namespace) {
            name = namespace + ':' + name;
            // TODO(FW-811): Ivy may cause issues here because it's passing around
            // full URIs for namespaces, therefore this lookup will fail.
            const namespaceUri = NAMESPACE_URIS[namespace];
            if (namespaceUri) {
                el.setAttributeNS(namespaceUri, name, value);
            }
            else {
                el.setAttribute(name, value);
            }
        }
        else {
            el.setAttribute(name, value);
        }
    }
    setProperty(el, name, value) {
        el.setNgProperty(name, value);
    }
    setStyle(el, style, value, flags) {
        if (el.style) {
            // tslint:disable-next-line:no-bitwise
            if (flags & RendererStyleFlags2.DashCase) {
                el.style.setProperty(
                // tslint:disable-next-line:no-bitwise
                style, value, flags & RendererStyleFlags2.Important ? 'important' : '');
            }
            else {
                el.style[style] = value;
            }
        }
        else {
            el.setStyle(style, value, flags);
        }
    }
    setValue(node, value) {
        if (node.setValue) {
            node.setValue(value);
        }
        else {
            node.nodeValue = value;
        }
    }
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLWRvbS1yZW5kZXJlci5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vaXJ1c3RtL2Rldi9naXRodWIvYW5ndWxhci1jYW52YXMvcHJvamVjdHMvYW5ndWxhci1jYW52YXMtbGliL3NyYy9saWIvY2FudmFzLWRvbS1yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsTUFBTSxFQUNOLFVBQVUsRUFDVixNQUFNLEVBR04sbUJBQW1CLEVBRW5CLGlCQUFpQixHQUNsQixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDbEQsT0FBTyxFQUNMLFlBQVksRUFDWixvQkFBb0IsSUFBSSxtQkFBbUIsR0FDNUMsTUFBTSwyQkFBMkIsQ0FBQztBQUNuQyxPQUFPLEVBQ0wsbUJBQW1CLEVBQ25CLGlDQUFpQyxFQUNqQyxpQkFBaUIsR0FDbEIsTUFBTSx3QkFBd0IsQ0FBQztBQUNoQyxPQUFPLEVBQ0wsYUFBYSxFQUNiLGNBQWMsRUFDZCxvQkFBb0IsRUFDcEIsaUJBQWlCLEdBQ2xCLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDckUsT0FBTyxFQUNMLGtCQUFrQixHQUVuQixNQUFNLDZDQUE2QyxDQUFDOzs7QUFHckQsTUFBTSxPQUFPLHdCQUF3QjtBQUFHLElBSXRDLFlBQ21CLFlBQTBCLEVBQzFCLGdCQUFxQyxFQUNyQyxLQUFhLEVBQ2IsTUFBYyxFQUVkLFlBQXFDO0FBQ3ZELFFBTmtCLGlCQUFZLEdBQVosWUFBWSxDQUFjO0FBQUMsUUFDM0IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFxQjtBQUFDLFFBQ3RDLFVBQUssR0FBTCxLQUFLLENBQVE7QUFBQyxRQUNkLFdBQU0sR0FBTixNQUFNLENBQVE7QUFBQyxRQUVmLGlCQUFZLEdBQVosWUFBWSxDQUF5QjtB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Q3ZCLFlBQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMzQixTQUFLO0FBQUMsYUFBSztBQUNYLFlBQU0sSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7QUFDN0IsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNILENBQUM7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgTmdab25lLFxuICBSZW5kZXJlcjIsXG4gIFJlbmRlcmVyRmFjdG9yeTIsXG4gIFJlbmRlcmVyU3R5bGVGbGFnczIsXG4gIFJlbmRlcmVyVHlwZTIsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5nQ2FudmFzRWxlbWVudCB9IGZyb20gJy4vY29tcG9uZW50cy9uZy1jYW52YXMtZWxlbWVudCc7XG5pbXBvcnQgeyBOZ0NhbnZhcyB9IGZyb20gJy4vY29tcG9uZW50cy9uZy1jYW52YXMnO1xuaW1wb3J0IHtcbiAgRXZlbnRNYW5hZ2VyLFxuICDJtURvbVNoYXJlZFN0eWxlc0hvc3QgYXMgRG9tU2hhcmVkU3R5bGVzSG9zdCxcbn0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQge1xuICBEZWZhdWx0RG9tUmVuZGVyZXIyLFxuICBFbXVsYXRlZEVuY2Fwc3VsYXRpb25Eb21SZW5kZXJlcjIsXG4gIFNoYWRvd0RvbVJlbmRlcmVyLFxufSBmcm9tICcuL2RlZmF1bHQtZG9tLXJlbmRlcmVyJztcbmltcG9ydCB7XG4gIGZsYXR0ZW5TdHlsZXMsXG4gIE5BTUVTUEFDRV9VUklTLFxuICBzaGltQ29udGVudEF0dHJpYnV0ZSxcbiAgc2hpbUhvc3RBdHRyaWJ1dGUsXG59IGZyb20gJy4vcmVuZGVyZXItdXRpbHMnO1xuaW1wb3J0IHsgZ2V0TWV0YWRhdGFBcmdzU3RvcmFnZSB9IGZyb20gJy4vbWV0YWRhdGEvbWV0YWRhdGEtc3RvcmFnZSc7XG5pbXBvcnQge1xuICBDYW52YXNSZW5kZXJDb25maWcsXG4gIENhbnZhc1JlbmRlckNvbmZpZ01vZGVsLFxufSBmcm9tICcuL3Rva2Vucy9jYW52YXMtcmVzaXplLW9ic2VyZXItZW5hYmxlLXRva2VuJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhbnZhc0RvbVJlbmRlcmVyRmFjdG9yeSBpbXBsZW1lbnRzIFJlbmRlcmVyRmFjdG9yeTIge1xuICBwcml2YXRlIHJlbmRlcmVyQnlDb21wSWQgPSBuZXcgTWFwPHN0cmluZywgUmVuZGVyZXIyPigpO1xuICBwcml2YXRlIGRlZmF1bHRSZW5kZXJlcjogUmVuZGVyZXIyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzaGFyZWRTdHlsZXNIb3N0OiBEb21TaGFyZWRTdHlsZXNIb3N0LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXBwSWQ6IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5nWm9uZTogTmdab25lLFxuICAgIEBJbmplY3QoQ2FudmFzUmVuZGVyQ29uZmlnKVxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzQ29uZmlnOiBDYW52YXNSZW5kZXJDb25maWdNb2RlbFxuICApIHtcbiAgICB0aGlzLmRlZmF1bHRSZW5kZXJlciA9IG5ldyBEZWZhdWx0RG9tUmVuZGVyZXIyKGV2ZW50TWFuYWdlcik7XG4gIH1cblxuICBlbmQoKSB7fVxuXG4gIGNyZWF0ZVJlbmRlcmVyKGVsZW1lbnQ6IGFueSwgdHlwZTogUmVuZGVyZXJUeXBlMiB8IG51bGwpOiBSZW5kZXJlcjIge1xuICAgIGlmICghZWxlbWVudCB8fCAhdHlwZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdFJlbmRlcmVyO1xuICAgIH1cblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBpZiAodHlwZVsndHlwZSddICYmIHR5cGVbJ3R5cGUnXS5pc0NhbnZhc0NvbXBvbmVudCkge1xuICAgICAgbGV0IHJlbmRlcmVyID0gdGhpcy5yZW5kZXJlckJ5Q29tcElkLmdldCh0eXBlLmlkKTtcblxuICAgICAgaWYgKCFyZW5kZXJlcikge1xuICAgICAgICByZW5kZXJlciA9IG5ldyBDYW52YXNSZW5kZXJlcihcbiAgICAgICAgICB0aGlzLmV2ZW50TWFuYWdlcixcbiAgICAgICAgICB0aGlzLnNoYXJlZFN0eWxlc0hvc3QsXG4gICAgICAgICAgdHlwZSxcbiAgICAgICAgICB0aGlzLmFwcElkLFxuICAgICAgICAgIHRoaXMubmdab25lLFxuICAgICAgICAgIHRoaXMuY2FudmFzQ29uZmlnXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMucmVuZGVyZXJCeUNvbXBJZC5zZXQodHlwZS5pZCwgcmVuZGVyZXIpO1xuICAgICAgfVxuICAgICAgKHJlbmRlcmVyIGFzIENhbnZhc1JlbmRlcmVyKS5hcHBseVRvSG9zdChlbGVtZW50KTtcbiAgICAgIHJldHVybiByZW5kZXJlcjtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHR5cGUuZW5jYXBzdWxhdGlvbikge1xuICAgICAgY2FzZSBWaWV3RW5jYXBzdWxhdGlvbi5FbXVsYXRlZDoge1xuICAgICAgICBsZXQgcmVuZGVyZXIgPSB0aGlzLnJlbmRlcmVyQnlDb21wSWQuZ2V0KHR5cGUuaWQpO1xuICAgICAgICBpZiAoIXJlbmRlcmVyKSB7XG4gICAgICAgICAgcmVuZGVyZXIgPSBuZXcgRW11bGF0ZWRFbmNhcHN1bGF0aW9uRG9tUmVuZGVyZXIyKFxuICAgICAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIsXG4gICAgICAgICAgICB0aGlzLnNoYXJlZFN0eWxlc0hvc3QsXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgdGhpcy5hcHBJZFxuICAgICAgICAgICk7XG4gICAgICAgICAgdGhpcy5yZW5kZXJlckJ5Q29tcElkLnNldCh0eXBlLmlkLCByZW5kZXJlcik7XG4gICAgICAgIH1cbiAgICAgICAgKHJlbmRlcmVyIGFzIEVtdWxhdGVkRW5jYXBzdWxhdGlvbkRvbVJlbmRlcmVyMikuYXBwbHlUb0hvc3QoZWxlbWVudCk7XG4gICAgICAgIHJldHVybiByZW5kZXJlcjtcbiAgICAgIH1cbiAgICAgIGNhc2UgVmlld0VuY2Fwc3VsYXRpb24uU2hhZG93RG9tOlxuICAgICAgICByZXR1cm4gbmV3IFNoYWRvd0RvbVJlbmRlcmVyKFxuICAgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLFxuICAgICAgICAgIHRoaXMuc2hhcmVkU3R5bGVzSG9zdCxcbiAgICAgICAgICBlbGVtZW50LFxuICAgICAgICAgIHR5cGVcbiAgICAgICAgKTtcblxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICBpZiAoIXRoaXMucmVuZGVyZXJCeUNvbXBJZC5oYXModHlwZS5pZCkpIHtcbiAgICAgICAgICBjb25zdCBzdHlsZXMgPSBmbGF0dGVuU3R5bGVzKHR5cGUuaWQsIHR5cGUuc3R5bGVzLCBbXSk7XG4gICAgICAgICAgdGhpcy5zaGFyZWRTdHlsZXNIb3N0LmFkZFN0eWxlcyhzdHlsZXMpO1xuICAgICAgICAgIHRoaXMucmVuZGVyZXJCeUNvbXBJZC5zZXQodHlwZS5pZCwgdGhpcy5kZWZhdWx0UmVuZGVyZXIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIENhbnZhc1JlbmRlcmVyIGltcGxlbWVudHMgUmVuZGVyZXIyIHtcbiAgcHJpdmF0ZSBjb250ZW50QXR0cjogc3RyaW5nO1xuICBwcml2YXRlIGhvc3RBdHRyOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2FudmFzRWxlbWVudHMgPSBnZXRNZXRhZGF0YUFyZ3NTdG9yYWdlKCkuZWxlbWVudHM7XG5cbiAgcmVhZG9ubHkgZGF0YTogeyBbcDogc3RyaW5nXTogYW55IH07XG4gIGRlc3Ryb3lOb2RlOiAoKG5vZGU6IGFueSkgPT4gdm9pZCkgfCBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyLFxuICAgIHNoYXJlZFN0eWxlc0hvc3Q6IERvbVNoYXJlZFN0eWxlc0hvc3QsXG4gICAgcHJpdmF0ZSBjb21wb25lbnQ6IFJlbmRlcmVyVHlwZTIsXG4gICAgYXBwSWQ6IHN0cmluZyxcbiAgICBwcml2YXRlIG5nWm9uZTogTmdab25lLFxuICAgIHByaXZhdGUgY29uZmlnXG4gICkge1xuICAgIGNvbnN0IHN0eWxlcyA9IGZsYXR0ZW5TdHlsZXMoXG4gICAgICBhcHBJZCArICctJyArIGNvbXBvbmVudC5pZCxcbiAgICAgIGNvbXBvbmVudC5zdHlsZXMsXG4gICAgICBbXVxuICAgICk7XG4gICAgc2hhcmVkU3R5bGVzSG9zdC5hZGRTdHlsZXMoc3R5bGVzKTtcblxuICAgIHRoaXMuY29udGVudEF0dHIgPSBzaGltQ29udGVudEF0dHJpYnV0ZShhcHBJZCArICctJyArIGNvbXBvbmVudC5pZCk7XG4gICAgdGhpcy5ob3N0QXR0ciA9IHNoaW1Ib3N0QXR0cmlidXRlKGFwcElkICsgJy0nICsgY29tcG9uZW50LmlkKTtcbiAgfVxuXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0eXBlZGVmXG4gIGFwcGx5VG9Ib3N0KGVsZW1lbnQ6IGFueSkge1xuICAgIHRoaXMuc2V0QXR0cmlidXRlKGVsZW1lbnQsIHRoaXMuaG9zdEF0dHIsICcnKTtcbiAgfVxuXG4gIGNyZWF0ZUVsZW1lbnQobmFtZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcgfCBudWxsKTogYW55IHtcbiAgICBjb25zdCBDb21wb25lbnQgPSB0aGlzLmNhbnZhc0VsZW1lbnRzLmdldChuYW1lKTtcblxuICAgIGlmIChDb21wb25lbnQpIHtcbiAgICAgIHJldHVybiBuZXcgQ29tcG9uZW50KCk7XG4gICAgfSBlbHNlIGlmIChuYW1lID09PSAnY2FudmFzJykge1xuICAgICAgY29uc3QgY2FudmFzID0gbmV3IE5nQ2FudmFzKHRoaXMubmdab25lLCB0aGlzLmNvbmZpZyk7XG4gICAgICBjYW52YXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUodGhpcy5jb250ZW50QXR0ciwgJycpO1xuICAgICAgcmV0dXJuIGNhbnZhcztcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGVsZW1lbnQ7XG4gICAgICBpZiAobmFtZXNwYWNlKSB7XG4gICAgICAgIC8vIEluIGNhc2VzIHdoZXJlIEl2eSAobm90IFZpZXdFbmdpbmUpIGlzIGdpdmluZyB1cyB0aGUgYWN0dWFsIG5hbWVzcGFjZSwgdGhlIGxvb2sgdXAgYnkga2V5XG4gICAgICAgIC8vIHdpbGwgcmVzdWx0IGluIHVuZGVmaW5lZCwgc28gd2UganVzdCByZXR1cm4gdGhlIG5hbWVzcGFjZSBoZXJlLlxuICAgICAgICBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFxuICAgICAgICAgIE5BTUVTUEFDRV9VUklTW25hbWVzcGFjZV0gfHwgbmFtZXNwYWNlLFxuICAgICAgICAgIG5hbWVcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG5hbWUpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnNldEF0dHJpYnV0ZShlbGVtZW50LCB0aGlzLmNvbnRlbnRBdHRyLCAnJyk7XG4gICAgICByZXR1cm4gZWxlbWVudDtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVUZXh0KHZhbHVlOiBzdHJpbmcpOiBhbnkge1xuICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh2YWx1ZSk7XG4gIH1cblxuICBzZWxlY3RSb290RWxlbWVudChzZWxlY3Rvck9yTm9kZTogYW55LCBwcmVzZXJ2ZUNvbnRlbnQ/OiBib29sZWFuKTogYW55IHtcbiAgICBjb25zdCBlbDogYW55ID1cbiAgICAgIHR5cGVvZiBzZWxlY3Rvck9yTm9kZSA9PT0gJ3N0cmluZydcbiAgICAgICAgPyBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yT3JOb2RlKVxuICAgICAgICA6IHNlbGVjdG9yT3JOb2RlO1xuICAgIGlmICghZWwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBzZWxlY3RvciBcIiR7c2VsZWN0b3JPck5vZGV9XCIgZGlkIG5vdCBtYXRjaCBhbnkgZWxlbWVudHNgXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoIXByZXNlcnZlQ29udGVudCkge1xuICAgICAgZWwudGV4dENvbnRlbnQgPSAnJztcbiAgICB9XG4gICAgcmV0dXJuIGVsO1xuICB9XG5cbiAgYWRkQ2xhc3MoZWw6IE5nQ2FudmFzRWxlbWVudCwgbmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGVsLmNsYXNzTGlzdCkge1xuICAgICAgZWwuY2xhc3NMaXN0LmFkZChuYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZWwuYWRkQ2xhc3MobmFtZSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlQ2xhc3MoZWw6IE5nQ2FudmFzRWxlbWVudCwgbmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGVsLmNsYXNzTGlzdCkge1xuICAgICAgZWwuY2xhc3NMaXN0LmFkZChuYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZWwucmVtb3ZlQ2xhc3MobmFtZSk7XG4gICAgfVxuICB9XG5cbiAgYXBwZW5kQ2hpbGQocGFyZW50OiBOZ0NhbnZhc0VsZW1lbnQsIG5ld0NoaWxkOiBOZ0NhbnZhc0VsZW1lbnQpOiB2b2lkIHtcbiAgICAvLyBwYXJlbnQuYXBwZW5kQ2hpbGQobmV3Q2hpbGQpO1xuICAgIGlmICghbmV3Q2hpbGQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbmV3Q2hpbGQucGFyZW50ID0gcGFyZW50IGFzIGFueTtcblxuICAgIGlmIChuZXdDaGlsZCBpbnN0YW5jZW9mIE5nQ2FudmFzKSB7XG4gICAgICBwYXJlbnQuYXBwZW5kQ2hpbGQoKG5ld0NoaWxkIGFzIE5nQ2FudmFzKS5lbGVtZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50LmFwcGVuZENoaWxkKG5ld0NoaWxkKTtcbiAgICB9XG4gIH1cblxuICByZW1vdmVDaGlsZChwYXJlbnQ6IE5nQ2FudmFzRWxlbWVudCwgb2xkQ2hpbGQpOiB2b2lkIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW51c2VkLWV4cHJlc3Npb25cbiAgICBvbGRDaGlsZC5kZXN0cm95ICYmIG9sZENoaWxkLmRlc3Ryb3koKTtcbiAgICBpZiAocGFyZW50KSB7XG4gICAgICBwYXJlbnQucmVtb3ZlQ2hpbGQob2xkQ2hpbGQpO1xuICAgIH1cbiAgICBpZiAob2xkQ2hpbGQgJiYgb2xkQ2hpbGQucGFyZW50IGluc3RhbmNlb2YgTmdDYW52YXMpIHtcbiAgICAgIG9sZENoaWxkLnBhcmVudC5yZW1vdmVDaGlsZChvbGRDaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlQ29tbWVudCh2YWx1ZTogc3RyaW5nKTogYW55IHtcbiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlQ29tbWVudCh2YWx1ZSk7XG4gIH1cblxuICBkZXN0cm95KCk6IHZvaWQge31cblxuICBpbnNlcnRCZWZvcmUocGFyZW50OiBOZ0NhbnZhc0VsZW1lbnQsIG5ld0NoaWxkOiBhbnksIHJlZkNoaWxkOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAocGFyZW50ICYmIHBhcmVudC5pbnNlcnRCZWZvcmUpIHtcbiAgICAgIG5ld0NoaWxkLnBhcmVudCA9IHBhcmVudDtcblxuICAgICAgaWYgKG5ld0NoaWxkIGluc3RhbmNlb2YgTmdDYW52YXMpIHtcbiAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZSgobmV3Q2hpbGQgYXMgTmdDYW52YXMpLmVsZW1lbnQsIHJlZkNoaWxkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUobmV3Q2hpbGQsIHJlZkNoaWxkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsaXN0ZW4oXG4gICAgdGFyZ2V0OiBhbnksXG4gICAgZXZlbnROYW1lOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6IChldmVudDogYW55KSA9PiBib29sZWFuIHwgdm9pZFxuICApOiAoKSA9PiB2b2lkIHtcbiAgICBjb25zdCBjYWxsYmFja0Z1bmMgPSAoZTogYW55KSA9PiBjYWxsYmFjay5jYWxsKHRhcmdldCwgZSk7XG5cbiAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgTmdDYW52YXMpIHtcbiAgICAgIHRhcmdldCA9IHRhcmdldC5lbGVtZW50O1xuICAgIH1cblxuICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgY2FsbGJhY2tGdW5jKTtcblxuICAgIHJldHVybiAoKSA9PiB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrRnVuYyk7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dHlwZWRlZlxuICBuZXh0U2libGluZyhub2RlOiBhbnkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHJldmlvdXM6IG5vZGUsXG4gICAgICBuZXh0OiBub2RlLm5leHRTaWJsaW5nLFxuICAgIH07XG4gIH1cblxuICBwYXJlbnROb2RlKG5vZGU6IGFueSk6IGFueSB7XG4gICAgcmV0dXJuIG5vZGUucGFyZW50ID8gbm9kZS5wYXJlbnQgOiBub2RlO1xuICB9XG5cbiAgcmVtb3ZlQXR0cmlidXRlKFxuICAgIGVsOiBOZ0NhbnZhc0VsZW1lbnQsXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIG5hbWVzcGFjZT86IHN0cmluZyB8IG51bGxcbiAgKTogdm9pZCB7XG4gICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgLy8gVE9ETyhGVy04MTEpOiBJdnkgbWF5IGNhdXNlIGlzc3VlcyBoZXJlIGJlY2F1c2UgaXQncyBwYXNzaW5nIGFyb3VuZFxuICAgICAgLy8gZnVsbCBVUklzIGZvciBuYW1lc3BhY2VzLCB0aGVyZWZvcmUgdGhpcyBsb29rdXAgd2lsbCBmYWlsLlxuICAgICAgY29uc3QgbmFtZXNwYWNlVXJpID0gTkFNRVNQQUNFX1VSSVNbbmFtZXNwYWNlXTtcbiAgICAgIGlmIChuYW1lc3BhY2VVcmkpIHtcbiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlTlMobmFtZXNwYWNlVXJpLCBuYW1lKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFRPRE8oRlctODExKTogU2luY2UgaXZ5IGlzIHBhc3NpbmcgYXJvdW5kIGZ1bGwgVVJJcyBmb3IgbmFtZXNwYWNlc1xuICAgICAgICAvLyB0aGlzIGNvdWxkIHJlc3VsdCBpbiBwcm9wZXJ0aWVzIGxpa2UgYGh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnOmN4PVwiMTIzXCJgLFxuICAgICAgICAvLyB3aGljaCBpcyB3cm9uZy5cbiAgICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGAke25hbWVzcGFjZX06JHtuYW1lfWApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlU3R5bGUoXG4gICAgZWw6IE5nQ2FudmFzRWxlbWVudCxcbiAgICBzdHlsZTogc3RyaW5nLFxuICAgIGZsYWdzPzogUmVuZGVyZXJTdHlsZUZsYWdzMlxuICApOiB2b2lkIHtcbiAgICBlbC5yZW1vdmVTdHlsZShzdHlsZSwgZmxhZ3MpO1xuICB9XG5cbiAgc2V0QXR0cmlidXRlKFxuICAgIGVsOiBOZ0NhbnZhc0VsZW1lbnQsXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHZhbHVlOiBzdHJpbmcsXG4gICAgbmFtZXNwYWNlPzogc3RyaW5nIHwgbnVsbFxuICApOiB2b2lkIHtcbiAgICBpZiAobmFtZXNwYWNlKSB7XG4gICAgICBuYW1lID0gbmFtZXNwYWNlICsgJzonICsgbmFtZTtcbiAgICAgIC8vIFRPRE8oRlctODExKTogSXZ5IG1heSBjYXVzZSBpc3N1ZXMgaGVyZSBiZWNhdXNlIGl0J3MgcGFzc2luZyBhcm91bmRcbiAgICAgIC8vIGZ1bGwgVVJJcyBmb3IgbmFtZXNwYWNlcywgdGhlcmVmb3JlIHRoaXMgbG9va3VwIHdpbGwgZmFpbC5cbiAgICAgIGNvbnN0IG5hbWVzcGFjZVVyaSA9IE5BTUVTUEFDRV9VUklTW25hbWVzcGFjZV07XG4gICAgICBpZiAobmFtZXNwYWNlVXJpKSB7XG4gICAgICAgIGVsLnNldEF0dHJpYnV0ZU5TKG5hbWVzcGFjZVVyaSwgbmFtZSwgdmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZWwuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZWwuc2V0QXR0cmlidXRlKG5hbWUsIHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBzZXRQcm9wZXJ0eShlbDogTmdDYW52YXNFbGVtZW50LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBlbC5zZXROZ1Byb3BlcnR5KG5hbWUsIHZhbHVlKTtcbiAgfVxuXG4gIHNldFN0eWxlKFxuICAgIGVsOiBOZ0NhbnZhc0VsZW1lbnQsXG4gICAgc3R5bGU6IHN0cmluZyxcbiAgICB2YWx1ZTogYW55LFxuICAgIGZsYWdzPzogUmVuZGVyZXJTdHlsZUZsYWdzMlxuICApOiB2b2lkIHtcbiAgICBpZiAoZWwuc3R5bGUpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgICBpZiAoZmxhZ3MgJiBSZW5kZXJlclN0eWxlRmxhZ3MyLkRhc2hDYXNlKSB7XG4gICAgICAgIGVsLnN0eWxlLnNldFByb3BlcnR5KFxuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgZmxhZ3MgJiBSZW5kZXJlclN0eWxlRmxhZ3MyLkltcG9ydGFudCA/ICdpbXBvcnRhbnQnIDogJydcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGVsLnN0eWxlW3N0eWxlXSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBlbC5zZXRTdHlsZShzdHlsZSwgdmFsdWUsIGZsYWdzKTtcbiAgICB9XG4gIH1cblxuICBzZXRWYWx1ZShub2RlOiBhbnksIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAobm9kZS5zZXRWYWx1ZSkge1xuICAgICAgbm9kZS5zZXRWYWx1ZSh2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vZGUubm9kZVZhbHVlID0gdmFsdWU7XG4gICAgfVxuICB9XG59XG4iXX0=